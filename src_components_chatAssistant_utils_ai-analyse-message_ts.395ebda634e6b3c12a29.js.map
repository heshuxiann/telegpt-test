{"version":3,"file":"src_components_chatAssistant_utils_ai-analyse-message_ts.395ebda634e6b3c12a29.js","mappings":"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","sources":["webpack://TelyAI/./src/components/chatAssistant/utils/ai-analyse-message.ts","webpack://TelyAI/ignored|/Users/qmk/work/telegram-tt/node_modules/pdfjs-dist/legacy/build|fs","webpack://TelyAI/ignored|/Users/qmk/work/telegram-tt/node_modules/pdfjs-dist/legacy/build|http","webpack://TelyAI/ignored|/Users/qmk/work/telegram-tt/node_modules/pdfjs-dist/legacy/build|canvas","webpack://TelyAI/ignored|/Users/qmk/work/telegram-tt/node_modules/pdfjs-dist/legacy/build|zlib","webpack://TelyAI/ignored|/Users/qmk/work/telegram-tt/node_modules/pdfjs-dist/legacy/build|url","webpack://TelyAI/ignored|/Users/qmk/work/telegram-tt/node_modules/pdfjs-dist/legacy/build|https"],"sourcesContent":["/* eslint-disable */\nimport { v4 as uuidv4 } from \"uuid\";\nimport { ApiMessage } from \"../../../api/types\";\nimport eventEmitter, { Actions } from \"../lib/EventEmitter\";\nimport { ChataiStores } from \"../store\";\nimport { StoreMessage } from \"../store/messages-store\";\nimport {\n  audioAISummary,\n  documentAISummary,\n  imageAISummary,\n  mentionReply,\n  webPageAISummary,\n} from \"./chat-api\";\nimport { sleep } from \"../ai-chatfolders/util\";\nimport { getMediaHash } from \"../../../global/helpers\";\nimport * as mediaLoader from \"../../../util/mediaLoader\";\nimport { message as showMessage } from \"antd\";\nimport * as pdfjsLib from \"pdfjs-dist/legacy/build/pdf\";\nimport { getActions, getGlobal } from \"../../../global\";\nimport {\n  selectChatMessage,\n  selectWebPageFromMessage,\n} from \"../../../global/selectors\";\nimport { AIMessageType } from \"../messages/types\";\n\npdfjsLib.GlobalWorkerOptions.workerSrc = \"pdf.worker.min.js\";\n\nconst mammoth = require(\"mammoth\");\n\nexport async function replyToMention(\n  message: ApiMessage,\n  isAuto: boolean = false,\n) {\n  if (!message.isMentioned || !message.content?.text?.text) return;\n\n  let newMessage: StoreMessage = {\n    chatId: message.chatId,\n    timestamp: new Date().getTime(),\n    id: uuidv4(),\n    createdAt: new Date(),\n    role: \"assistant\",\n    type: AIMessageType.AIReplyMention,\n    content: JSON.stringify({\n      messageId: message.id,\n      content: message.content.text?.text,\n      isAuto,\n      status: \"loading\",\n    }),\n  };\n  await sendMessageToAIRoom(newMessage);\n\n  mentionReply({\n    message: message.content.text?.text,\n    language: getAutoTransLang(),\n  })\n    .then((response: any) => {\n      if (response.text) {\n        newMessage = {\n          ...newMessage,\n          content: JSON.stringify({\n            messageId: message.id,\n            content: message.content.text?.text,\n            replys: response.text,\n            isAuto,\n            status: \"success\",\n          }),\n        };\n        sendMessageToAIRoom(newMessage);\n      } else {\n        sendErrorMessage(newMessage, message, isAuto);\n      }\n    })\n    .catch((err) => {\n      console.log(\"error\", err);\n      sendErrorMessage(newMessage, message, isAuto);\n    });\n}\n\nexport async function photoSummary(\n  message: ApiMessage,\n  isAuto: boolean = false,\n) {\n  const photo = message.content?.photo;\n  if (!photo) return;\n  const mediaHash = getMediaHash(photo, \"download\");\n  if (!mediaHash) return;\n  const mimeType = \"image/jpeg\";\n\n  let newMessage: StoreMessage = {\n    chatId: message.chatId,\n    timestamp: new Date().getTime(),\n    id: uuidv4(),\n    createdAt: new Date(),\n    role: \"assistant\",\n    type: AIMessageType.AIMediaSummary,\n    content: JSON.stringify({ message, isAuto, status: \"loading\" }),\n  };\n  await sendMessageToAIRoom(newMessage);\n\n  await handleImageToSummaryText({\n    mimeType,\n    mediaHash,\n    message,\n    newMessage,\n    isAuto,\n  });\n}\n\nexport async function webPageSummary(\n  message: ApiMessage,\n  isAuto: boolean = false,\n) {\n  // const webPage = message.content?.webPage;\n  const global = getGlobal();\n  const webPage = selectWebPageFromMessage(global, message);\n  const url = webPage ? webPage?.url : message.content?.text?.text;\n  if (!url || url === \"\") return;\n\n  let newMessage: StoreMessage = {\n    chatId: message.chatId,\n    timestamp: new Date().getTime(),\n    id: uuidv4(),\n    createdAt: new Date(),\n    role: \"assistant\",\n    type: AIMessageType.AIMediaSummary,\n    content: JSON.stringify({ message, isAuto, status: \"loading\" }),\n  };\n  await sendMessageToAIRoom(newMessage);\n\n  webPageAISummary({\n    url,\n    text: message.content?.text?.text || \"\",\n    language: getAutoTransLang(),\n  })\n    .then((response: any) => {\n      if (response?.text) {\n        newMessage = {\n          ...newMessage,\n          content: JSON.stringify({\n            message,\n            summaryInfo: response?.text,\n            isAuto,\n            status: \"success\",\n          }),\n        };\n        sendMessageToAIRoom(newMessage);\n      } else {\n        sendErrorMessage(newMessage, message, isAuto);\n      }\n    })\n    .catch((err) => {\n      console.log(\"error\", err);\n      sendErrorMessage(newMessage, message, isAuto);\n    });\n}\n\nexport async function documentSummary(\n  message: ApiMessage,\n  isAuto: boolean = false,\n) {\n  const document = message.content?.document;\n  if (!document) return;\n\n  const mediaHash = getMediaHash(document, \"download\");\n  if (!mediaHash) return;\n  if (checkIsImage(document.mimeType) && isAuto) return;\n\n  let newMessage: StoreMessage = {\n    chatId: message.chatId,\n    timestamp: new Date().getTime(),\n    id: uuidv4(),\n    createdAt: new Date(),\n    role: \"assistant\",\n    type: AIMessageType.AIMediaSummary,\n    content: JSON.stringify({ message, isAuto, status: \"loading\" }),\n  };\n  await sendMessageToAIRoom(newMessage);\n\n  // image\n  if (checkIsImage(document.mimeType)) {\n    handleImageToSummaryText({\n      mimeType: document.mimeType,\n      mediaHash,\n      message,\n      newMessage,\n      isAuto,\n    });\n    return;\n  }\n  // video\n  if (checkIsVideo(document.mimeType)) {\n    await handleAudioToSummaryText({\n      mediaHash,\n      mimeType: document?.mimeType,\n      filename: document?.fileName,\n      size: document?.size,\n      newMessage,\n      message,\n      isAuto,\n    });\n    return;\n  }\n\n  await mediaLoader.fetch(mediaHash, 0);\n  const blobUrl = mediaLoader.getFromMemory(mediaHash);\n  if (!blobUrl) return;\n\n  const response = await fetch(blobUrl);\n  const blob = await response.blob();\n\n  const arrayBuffer = await blob.arrayBuffer();\n  let text = \"\";\n  switch (document.mimeType) {\n    case \"text/plain\":\n      text = new TextDecoder().decode(arrayBuffer);\n      break;\n    case \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\":\n    case \"application/msword\":\n      const result = await mammoth.extractRawText({ arrayBuffer });\n      text = result.value;\n      break;\n    case \"application/pdf\":\n      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;\n      let pdfText = \"\";\n      for (let i = 1; i <= pdf.numPages; i++) {\n        const page = await pdf.getPage(i);\n        const content = await page.getTextContent();\n        const pageText = content.items.map((item: any) => item.str).join(\" \");\n        pdfText += pageText + \"\\n\";\n      }\n      text = pdfText;\n      break;\n    default:\n      await sendErrorMessage(newMessage, message, isAuto);\n      return;\n  }\n  if (text === \"\") {\n    await sendErrorMessage(newMessage, message, isAuto);\n    return;\n  }\n\n  documentAISummary({\n    content: text,\n    language: getAutoTransLang(),\n  })\n    .then((response: any) => {\n      if (response?.text) {\n        newMessage = {\n          ...newMessage,\n          content: JSON.stringify({\n            message: message,\n            summaryInfo: response?.text,\n            isAuto,\n            status: \"success\",\n          }),\n        };\n        sendMessageToAIRoom(newMessage);\n      } else {\n        sendErrorMessage(newMessage, message, isAuto);\n      }\n    })\n    .catch((err) => {\n      console.log(\"error\", err);\n      sendErrorMessage(newMessage, message, isAuto);\n    });\n}\n\nexport async function voiceSummary(\n  message: ApiMessage,\n  isAuto: boolean = false,\n) {\n  const voice = message.content?.voice;\n  if (!voice) return;\n\n  let newMessage: StoreMessage = {\n    chatId: message.chatId,\n    timestamp: new Date().getTime(),\n    id: uuidv4(),\n    createdAt: new Date(),\n    role: \"assistant\",\n    type: AIMessageType.AIMediaSummary,\n    content: JSON.stringify({ message, isAuto, status: \"loading\" }),\n  };\n  await sendMessageToAIRoom(newMessage);\n\n  let text = \"\";\n  const global = getGlobal();\n  const { isTranscriptionError, transcriptionId } = message;\n  if (isTranscriptionError) {\n    sendErrorMessage(newMessage, message, isAuto);\n    return;\n  }\n  if (transcriptionId && transcriptionId !== \"\") {\n    text = global?.transcriptions?.[transcriptionId]?.text;\n  } else {\n    await getActions().transcribeAudio({\n      chatId: message.chatId,\n      messageId: message.id,\n    });\n    await sleep(2000);\n    const newGlobal = getGlobal();\n    const currentMessage = selectChatMessage(\n      newGlobal,\n      message.chatId,\n      message.id,\n    );\n    if (currentMessage?.isTranscriptionError) {\n      sendErrorMessage(newMessage, message, isAuto);\n      return;\n    }\n    if (\n      currentMessage?.transcriptionId &&\n      currentMessage?.transcriptionId !== \"\"\n    ) {\n      text = newGlobal.transcriptions?.[currentMessage?.transcriptionId]?.text;\n    }\n  }\n  if (text === \"\") {\n    await sendErrorMessage(newMessage, message, isAuto);\n    return;\n  }\n  documentAISummary({\n    content: text,\n    language: getAutoTransLang(),\n  })\n    .then((response: any) => {\n      if (response?.text) {\n        newMessage = {\n          ...newMessage,\n          content: JSON.stringify({\n            message: message,\n            summaryInfo: response?.text,\n            isAuto,\n            status: \"success\",\n          }),\n        };\n        sendMessageToAIRoom(newMessage);\n      } else {\n        sendErrorMessage(newMessage, message, isAuto);\n      }\n    })\n    .catch((err) => {\n      console.log(\"error\", err);\n      sendErrorMessage(newMessage, message, isAuto);\n    });\n}\n\nexport async function voiceToAudioSummary(\n  message: ApiMessage,\n  isAuto: boolean = false,\n) {\n  const voice = message.content?.voice;\n  if (!voice) return;\n  const mediaHash = getMediaHash(voice, \"download\");\n  if (!mediaHash) return;\n  const maxBase64Length = Math.floor(4 * 1024 * 1024);\n  if (\n    message.content.audio?.size &&\n    message.content.audio?.size * (4 / 3) > maxBase64Length\n  ) {\n    showMessage.info(\"File size exceeds limit (4 MB)\");\n    return;\n  }\n  //\n  let newMessage: StoreMessage = {\n    chatId: message.chatId,\n    timestamp: new Date().getTime(),\n    id: uuidv4(),\n    createdAt: new Date(),\n    role: \"assistant\",\n    type: AIMessageType.AIMediaSummary,\n    content: JSON.stringify({ message, isAuto, status: \"loading\" }),\n  };\n  await sendMessageToAIRoom(newMessage);\n\n  await handleAudioToSummaryText({\n    mediaHash,\n    mimeType: \"audio/ogg\",\n    filename: voice?.id + \".ogg\",\n    size: voice?.size,\n    newMessage,\n    message,\n    isAuto,\n  });\n}\n\nexport async function audioSummary(\n  message: ApiMessage,\n  isAuto: boolean = false,\n) {\n  const audio = message.content?.audio;\n  if (!audio) return;\n  const mediaHash = getMediaHash(audio, \"download\");\n  if (!mediaHash) return;\n  //\n  let newMessage: StoreMessage = {\n    chatId: message.chatId,\n    timestamp: new Date().getTime(),\n    id: uuidv4(),\n    createdAt: new Date(),\n    role: \"assistant\",\n    type: AIMessageType.AIMediaSummary,\n    content: JSON.stringify({ message, isAuto, status: \"loading\" }),\n  };\n  await sendMessageToAIRoom(newMessage);\n\n  await handleAudioToSummaryText({\n    mediaHash,\n    mimeType: audio?.mimeType,\n    filename: audio?.fileName,\n    size: audio?.size,\n    newMessage,\n    message,\n    isAuto,\n  });\n}\n\nexport async function videoSummary(\n  message: ApiMessage,\n  isAuto: boolean = false,\n) {\n  const video = message.content?.video;\n  if (!video) return;\n  const mediaHash = getMediaHash(video, \"download\");\n  if (!mediaHash) return;\n  //\n  let newMessage: StoreMessage = {\n    chatId: message.chatId,\n    timestamp: new Date().getTime(),\n    id: uuidv4(),\n    createdAt: new Date(),\n    role: \"assistant\",\n    type: AIMessageType.AIMediaSummary,\n    content: JSON.stringify({ message, isAuto, status: \"loading\" }),\n  };\n  await sendMessageToAIRoom(newMessage);\n  if (video?.mimeType !== \"video/mp4\") {\n    await sendErrorMessage(newMessage, message, isAuto);\n    return;\n  }\n\n  await handleAudioToSummaryText({\n    mediaHash,\n    mimeType: video?.mimeType,\n    filename: video?.fileName,\n    size: video?.size,\n    newMessage,\n    message,\n    isAuto,\n  });\n}\n\nasync function sendMessageToAIRoom(newMessage: StoreMessage) {\n  await ChataiStores.message?.storeMessage(newMessage);\n  await eventEmitter.emit(Actions.AddRoomAIMessage, newMessage);\n}\n\nasync function handleAudioToSummaryText({\n  mediaHash,\n  mimeType,\n  filename,\n  size,\n  newMessage,\n  message,\n  isAuto,\n}: {\n  mediaHash: string;\n  mimeType?: string;\n  filename?: string;\n  size?: number;\n  newMessage: StoreMessage;\n  message: ApiMessage;\n  isAuto: boolean;\n}) {\n  try {\n    // check size\n    if (\n      (isAuto && size && size > 50 * 1024 * 1024) ||\n      (!isAuto && size && size > 100 * 1024 * 1024)\n    ) {\n      showMessage.info(\"File too large to summarize\");\n      newMessage = {\n        ...newMessage,\n        content: JSON.stringify({\n          message,\n          errorMsg: \"File too large to summarize\",\n          isAuto,\n          status: \"error\",\n        }),\n      };\n      await sendMessageToAIRoom(newMessage);\n      return;\n    }\n    // download\n    await mediaLoader.fetch(mediaHash, 0);\n    const blobUrl = mediaLoader.getFromMemory(mediaHash);\n    if (!blobUrl) {\n      sendErrorMessage(newMessage, message, isAuto);\n      return;\n    }\n\n    const response = await fetch(blobUrl);\n    const blob = await response.blob();\n    //\n    const formData = new FormData();\n    formData.append(\"file\", blob, filename || \"audio.ogg\");\n    formData.append(\"language\", getAutoTransLang());\n    if (mimeType) formData.append(\"mimeType\", mimeType);\n\n    const summaryResponse: any = await audioAISummary(formData);\n    if (summaryResponse?.text) {\n      newMessage = {\n        ...newMessage,\n        content: JSON.stringify({\n          message,\n          summaryInfo: summaryResponse?.text,\n          isAuto,\n          status: \"success\",\n        }),\n      };\n      sendMessageToAIRoom(newMessage);\n    } else {\n      sendErrorMessage(newMessage, message, isAuto);\n    }\n  } catch (err) {\n    console.log(\"error\", err);\n    sendErrorMessage(newMessage, message, isAuto);\n  }\n}\n\nasync function handleImageToSummaryText({\n  mimeType,\n  mediaHash,\n  message,\n  newMessage,\n  isAuto,\n}: {\n  mimeType: string;\n  mediaHash: string;\n  message: ApiMessage;\n  newMessage: StoreMessage;\n  isAuto: boolean;\n}) {\n  // download\n  await mediaLoader.fetch(mediaHash, 0);\n  const blobUrl = mediaLoader.getFromMemory(mediaHash);\n  if (!blobUrl) {\n    sendErrorMessage(newMessage, message, isAuto);\n    return;\n  }\n\n  const response = await fetch(blobUrl);\n  const blob = await response.blob();\n\n  const reader = new FileReader();\n  reader.onloadend = function () {\n    const base64Data = reader.result?.toString().split(\",\")[1] || \"\";\n    imageAISummary({\n      image: `data:${mimeType};base64,` + base64Data,\n      language: getAutoTransLang(),\n    })\n      .then((response: any) => {\n        if (response?.text) {\n          newMessage = {\n            ...newMessage,\n            content: JSON.stringify({\n              message,\n              summaryInfo: JSON.stringify({ text: response?.text }),\n              isAuto,\n              status: \"success\",\n            }),\n          };\n          sendMessageToAIRoom(newMessage);\n        } else {\n          sendErrorMessage(newMessage, message, isAuto);\n        }\n      })\n      .catch((err) => {\n        console.log(\"error\", err);\n        sendErrorMessage(newMessage, message, isAuto);\n      });\n  };\n  reader.readAsDataURL(blob);\n}\n\nexport function canSummarize(message: ApiMessage) {\n  const { photo, document, webPage, voice, audio, text, video } =\n    message?.content;\n  const isUrl = checkIsUrl(text?.text);\n  const hasText = text?.text && text.text.trim() !== \"\";\n\n  return (\n    photo ||\n    document ||\n    (webPage && !hasText) ||\n    voice ||\n    audio ||\n    isUrl ||\n    video\n  );\n}\n\nexport function isHasUrl(text?: string) {\n  const urls = extractUrls(text);\n  const hasUrl = urls.length > 0;\n\n  return hasUrl;\n}\n\nexport function checkIsUrl(text?: string) {\n  return (\n    typeof text === \"string\" &&\n    /^https?:\\/\\/[\\w\\-._~:/?#[\\]@!$&'()*+,;=%]+$/i.test(text)\n  );\n}\n\nexport function checkIsImage(mimeType: string) {\n  return mimeType.startsWith(\"image/\");\n}\n\nasync function sendErrorMessage(\n  newMessage: StoreMessage,\n  message: ApiMessage,\n  isAuto: boolean,\n) {\n  newMessage = {\n    ...newMessage,\n    content: JSON.stringify({\n      message,\n      isAuto,\n      status: \"error\",\n    }),\n  };\n  await sendMessageToAIRoom(newMessage);\n}\n\nexport function getAutoTransLang() {\n  const global = getGlobal();\n  const { telyAiLanguage = \"en\" } = global.settings.byKey;\n\n  return (\n    new Intl.DisplayNames([telyAiLanguage], { type: \"language\" }).of(\n      telyAiLanguage,\n    ) || \"en\"\n  );\n}\n\nexport function extractUrls(text?: string): string[] {\n  if (typeof text !== \"string\") return [];\n\n  const urlRegex = /https?:\\/\\/[\\w\\-._~:/?#[\\]@!$&'()*+,;=%]+/gi;\n  return text.match(urlRegex) || [];\n}\n\nexport function checkIsVideo(mimeType: string) {\n  return [\"video/mp4\"].indexOf(mimeType) >= 0;\n}\n","/* (ignored) */","/* (ignored) */","/* (ignored) */","/* (ignored) */","/* (ignored) */","/* (ignored) */"],"names":["v4","uuidv4","eventEmitter","Actions","ChataiStores","audioAISummary","documentAISummary","imageAISummary","mentionReply","webPageAISummary","sleep","getMediaHash","mediaLoader","message","showMessage","pdfjsLib","getActions","getGlobal","selectChatMessage","selectWebPageFromMessage","AIMessageType","GlobalWorkerOptions","workerSrc","mammoth","require","replyToMention","isAuto","isMentioned","content","text","newMessage","chatId","timestamp","Date","getTime","id","createdAt","role","type","AIReplyMention","JSON","stringify","messageId","status","sendMessageToAIRoom","language","getAutoTransLang","then","response","replys","sendErrorMessage","catch","err","console","log","photoSummary","photo","mediaHash","mimeType","AIMediaSummary","handleImageToSummaryText","webPageSummary","global","webPage","url","summaryInfo","documentSummary","document","checkIsImage","checkIsVideo","handleAudioToSummaryText","filename","fileName","size","fetch","blobUrl","getFromMemory","blob","arrayBuffer","TextDecoder","decode","result","extractRawText","value","pdf","getDocument","data","promise","pdfText","i","numPages","page","getPage","getTextContent","pageText","items","map","item","str","join","voiceSummary","voice","isTranscriptionError","transcriptionId","transcriptions","transcribeAudio","newGlobal","currentMessage","voiceToAudioSummary","maxBase64Length","Math","floor","audio","info","audioSummary","videoSummary","video","storeMessage","emit","AddRoomAIMessage","errorMsg","formData","FormData","append","summaryResponse","reader","FileReader","onloadend","base64Data","toString","split","image","readAsDataURL","canSummarize","isUrl","checkIsUrl","hasText","trim","isHasUrl","urls","extractUrls","hasUrl","length","test","startsWith","telyAiLanguage","settings","byKey","Intl","DisplayNames","of","urlRegex","match","indexOf"],"ignoreList":[],"sourceRoot":""}