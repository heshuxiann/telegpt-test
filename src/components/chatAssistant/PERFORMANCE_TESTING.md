# ChatAssistant æ€§èƒ½æµ‹è¯•æŒ‡å—

æœ¬æŒ‡å—ç”¨äºæµ‹è¯•å’ŒéªŒè¯ ChatAssistant æ¨¡å—çš„æ€§èƒ½ä¿®å¤æ•ˆæœã€‚

## ğŸ› å·²ä¿®å¤çš„é—®é¢˜

### 1. MutationObserver æ— é™å¾ªç¯
**ä½ç½®**: `use-scroll-to-bottom.ts`
**é—®é¢˜**: ç›‘å¬æ‰€æœ‰ DOM å˜åŒ–å¯¼è‡´ scrollIntoView è§¦å‘å¾ªç¯
**ä¿®å¤**:
- åªç›‘å¬ childList å˜åŒ–
- æ·»åŠ  50ms é˜²æŠ–æœºåˆ¶
- æ·»åŠ  isScrolling æ ‡å¿—é˜²æ­¢é‡å¤è§¦å‘

### 2. æ¸²æŸ“å‡½æ•°å‰¯ä½œç”¨
**ä½ç½®**: `messages.tsx:50-52`
**é—®é¢˜**: æ¯æ¬¡æ¸²æŸ“éƒ½æ‰§è¡Œ IndexedDB æ“ä½œ
**ä¿®å¤**: å°†å‰¯ä½œç”¨ç§»åˆ° useEffect ä¸­

### 3. useEffect ä¾èµ–é“¾å¾ªç¯
**ä½ç½®**: `global-summary.tsx:74-90`
**é—®é¢˜**: ä¸¤ä¸ª useEffect ç›¸äº’ä¾èµ–å¯¼è‡´æ›´æ–°é£æš´
**ä¿®å¤**: åˆå¹¶ä¸ºä¸€ä¸ª useEffectï¼Œä½¿ç”¨ ref è·Ÿè¸ªå˜åŒ–

### 4. InfiniteScroll æ€§èƒ½é—®é¢˜
**ä½ç½®**: `InfiniteScroll.tsx:106-129`
**é—®é¢˜**: ç›‘å¬æ·±å±‚å­æ ‘å¯¼è‡´è¿‡åº¦è§¦å‘
**ä¿®å¤**:
- ä¸ç›‘å¬ subtree
- æ·»åŠ é˜²æŠ–å’Œæ ‡å¿—ä½
- åªå¤„ç† childList å˜åŒ–

## ğŸ“Š æ€§èƒ½ç›‘æ§å·¥å…·

### ä½¿ç”¨æ–¹æ³•

1. **è‡ªåŠ¨ç›‘æ§**
   æ€§èƒ½ç›‘æ§å·²é›†æˆåˆ°å…³é”®ç»„ä»¶ä¸­ï¼š
   - `ChatAssistant/Messages`
   - `ChatAssistant/GlobalSummary`

   å¼€å‘ç¯å¢ƒä¸‹ä¼šè‡ªåŠ¨å¯ç”¨ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

2. **æµè§ˆå™¨æ§åˆ¶å°å‘½ä»¤**
   æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

   ```javascript
   // æ‰“å°æ€§èƒ½æŠ¥å‘Š
   __printPerformanceReport()

   // è·å–æ‰€æœ‰æŒ‡æ ‡
   __getPerformanceMetrics()

   // æ¸…é™¤æ€§èƒ½æŒ‡æ ‡
   __clearPerformanceMetrics()
   ```

3. **æ·»åŠ è‡ªå®šä¹‰ç›‘æ§**
   åœ¨ä»»ä½•ç»„ä»¶ä¸­å¯¼å…¥å¹¶ä½¿ç”¨ï¼š

   ```typescript
   import { usePerformanceMonitor } from './hook/usePerformanceMonitor';

   function MyComponent() {
     usePerformanceMonitor('MyComponent', {
       logThreshold: 30,        // æ¯ 30 æ¬¡æ¸²æŸ“æ‰“å°ä¸€æ¬¡è­¦å‘Š
       slowRenderThreshold: 16  // è¶…è¿‡ 16ms çš„æ¸²æŸ“è§†ä¸ºæ…¢æ¸²æŸ“
     });
     // ...
   }
   ```

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: å¿«é€Ÿæ¶ˆæ¯æµæµ‹è¯•
**ç›®æ ‡**: éªŒè¯æµå¼æ¶ˆæ¯ä¸ä¼šå¯¼è‡´æµè§ˆå™¨å¡æ­»

**æ­¥éª¤**:
1. æ‰“å¼€ ChatAssistant
2. å¿«é€Ÿå‘é€ 10+ æ¡è¿ç»­æ¶ˆæ¯
3. è§‚å¯Ÿ AI å›å¤çš„æµå¼è¾“å‡º
4. æ‰“å¼€æ§åˆ¶å°è¿è¡Œ `__printPerformanceReport()`

**é¢„æœŸç»“æœ**:
- âœ… æ¶ˆæ¯æµç•…æ˜¾ç¤ºï¼Œæ— å¡é¡¿
- âœ… CPU ä½¿ç”¨ç‡ä¿æŒæ­£å¸¸ (< 50%)
- âœ… Messages ç»„ä»¶æ¸²æŸ“æ¬¡æ•°åˆç† (< 100 æ¬¡/åˆ†é’Ÿ)
- âœ… å¹³å‡æ¸²æŸ“æ—¶é—´ < 16ms

### åœºæ™¯ 2: é•¿æ—¶é—´ç¨³å®šæ€§æµ‹è¯•
**ç›®æ ‡**: éªŒè¯é•¿æ—¶é—´ä½¿ç”¨ä¸ä¼šå¯¼è‡´å†…å­˜æ³„æ¼

**æ­¥éª¤**:
1. æ‰“å¼€ Chrome DevTools > Performance Monitor
2. ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š
   - JavaScript heap size
   - DOM nodes
   - JS event listeners
3. ä½¿ç”¨ ChatAssistant 30 åˆ†é’Ÿ
4. è§‚å¯Ÿå†…å­˜å’Œ DOM èŠ‚ç‚¹æ˜¯å¦æŒç»­å¢é•¿

**é¢„æœŸç»“æœ**:
- âœ… JS heap size ç¨³å®šï¼Œæ— æŒç»­å¢é•¿
- âœ… DOM èŠ‚ç‚¹æ•°é‡åˆç† (< 5000)
- âœ… Event listeners ä¸ä¼šæŒç»­å¢åŠ 
- âœ… æ— å†…å­˜æ³„æ¼è­¦å‘Š

### åœºæ™¯ 3: æ»šåŠ¨æ€§èƒ½æµ‹è¯•
**ç›®æ ‡**: éªŒè¯æ»šåŠ¨æ“ä½œæµç•…

**æ­¥éª¤**:
1. åŠ è½½åŒ…å« 50+ æ¡æ¶ˆæ¯çš„èŠå¤©
2. å¿«é€Ÿæ»šåŠ¨åˆ°é¡¶éƒ¨åŠ è½½æ›´å¤šæ¶ˆæ¯
3. å¿«é€Ÿæ»šåŠ¨åˆ°åº•éƒ¨
4. è§‚å¯Ÿæ€§èƒ½ç›‘æ§æŒ‡æ ‡

**é¢„æœŸç»“æœ**:
- âœ… æ»šåŠ¨æµç•…ï¼Œæ— ç™½å±
- âœ… åŠ è½½æ›´å¤šæ¶ˆæ¯æ—¶ä½ç½®ä¿æŒæ­£ç¡®
- âœ… è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨æ­£å¸¸å·¥ä½œ
- âœ… FPS ä¿æŒ 60 å·¦å³

### åœºæ™¯ 4: å¤šæ ‡ç­¾å‹åŠ›æµ‹è¯•
**ç›®æ ‡**: éªŒè¯å¤šä¸ªèŠå¤©æ ‡ç­¾ä¸ä¼šç›¸äº’å½±å“

**æ­¥éª¤**:
1. æ‰“å¼€ 3+ ä¸ªä¸åŒçš„èŠå¤©
2. åœ¨æ¯ä¸ªèŠå¤©ä¸­å‘é€æ¶ˆæ¯
3. å¿«é€Ÿåˆ‡æ¢æ ‡ç­¾
4. è§‚å¯Ÿå†…å­˜å’Œ CPU ä½¿ç”¨æƒ…å†µ

**é¢„æœŸç»“æœ**:
- âœ… æ ‡ç­¾åˆ‡æ¢æµç•…
- âœ… æ¯ä¸ªæ ‡ç­¾çš„çŠ¶æ€ç‹¬ç«‹
- âœ… å†…å­˜ä½¿ç”¨åˆç†å¢é•¿
- âœ… æ— å´©æºƒæˆ–å¡æ­»

### åœºæ™¯ 5: æµå¼è¾“å‡ºå‹åŠ›æµ‹è¯•
**ç›®æ ‡**: éªŒè¯å¤§é‡æ–‡æœ¬æµå¼è¾“å‡ºä¸ä¼šå¯¼è‡´é—®é¢˜

**æ­¥éª¤**:
1. å‘ AI æé—®ï¼Œè¦æ±‚é•¿å›ç­”
2. è§‚å¯Ÿæµå¼è¾“å‡ºè¿‡ç¨‹
3. åŒæ—¶æ»šåŠ¨æŸ¥çœ‹å…¶ä»–æ¶ˆæ¯
4. æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡

**é¢„æœŸç»“æœ**:
- âœ… æ–‡æœ¬æµç•…è¾“å‡ºï¼Œæ— å¡é¡¿
- âœ… å¯ä»¥æ­£å¸¸æ»šåŠ¨æŸ¥çœ‹å†å²æ¶ˆæ¯
- âœ… MutationObserver ä¸ä¼šè¿‡åº¦è§¦å‘
- âœ… æ¸²æŸ“æ—¶é—´ä¿æŒåœ¨åˆç†èŒƒå›´

## ğŸ” é—®é¢˜è¯Šæ–­

### å¦‚ä½•åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ€§èƒ½é—®é¢˜ï¼Ÿ

#### ç—‡çŠ¶ 1: æµè§ˆå™¨å¡æ­»/æ— å“åº”
**å¯èƒ½åŸå› **:
- MutationObserver æ— é™å¾ªç¯
- useEffect ä¾èµ–å¾ªç¯
- åŒæ­¥æ“ä½œé˜»å¡ä¸»çº¿ç¨‹

**è¯Šæ–­æ–¹æ³•**:
1. æ‰“å¼€ Chrome DevTools > Performance
2. ç‚¹å‡» Record å¼€å§‹å½•åˆ¶
3. é‡ç°å¡æ­»é—®é¢˜
4. åœæ­¢å½•åˆ¶ï¼ŒæŸ¥çœ‹ç«ç„°å›¾
5. æ‰¾åˆ°è€—æ—¶æœ€é•¿çš„å‡½æ•°è°ƒç”¨

**æŸ¥çœ‹é‡ç‚¹**:
- `scrollIntoView` æ˜¯å¦è¢«é¢‘ç¹è°ƒç”¨
- `MutationObserver callback` æ˜¯å¦å ç”¨å¤§é‡æ—¶é—´
- æ˜¯å¦æœ‰é€’å½’è°ƒç”¨æ ˆ

#### ç—‡çŠ¶ 2: å†…å­˜æŒç»­å¢é•¿
**å¯èƒ½åŸå› **:
- Event listeners æœªæ¸…ç†
- useEffect cleanup å‡½æ•°ç¼ºå¤±
- é—­åŒ…å¼•ç”¨æœªé‡Šæ”¾

**è¯Šæ–­æ–¹æ³•**:
1. æ‰“å¼€ Chrome DevTools > Memory
2. æ‹æ‘„å †å¿«ç…§ (Heap Snapshot)
3. ä½¿ç”¨åº”ç”¨ 5-10 åˆ†é’Ÿ
4. å†æ¬¡æ‹æ‘„å †å¿«ç…§
5. é€‰æ‹© "Comparison" æŸ¥çœ‹æ–°å¢å¯¹è±¡

**æŸ¥çœ‹é‡ç‚¹**:
- Detached DOM nodes æ•°é‡
- Event Listener æ•°é‡
- å¤§å‹æ•°ç»„æˆ–å¯¹è±¡

#### ç—‡çŠ¶ 3: æ¸²æŸ“ç¼“æ…¢
**å¯èƒ½åŸå› **:
- ç»„ä»¶è¿‡åº¦æ¸²æŸ“
- å¤æ‚çš„æ¸²æŸ“é€»è¾‘
- ç¼ºå°‘ memo ä¼˜åŒ–

**è¯Šæ–­æ–¹æ³•**:
1. ä½¿ç”¨ `__printPerformanceReport()` æŸ¥çœ‹æ¸²æŸ“ç»Ÿè®¡
2. æ£€æŸ¥å“ªäº›ç»„ä»¶æ¸²æŸ“æ¬¡æ•°è¿‡å¤š
3. ä½¿ç”¨ React DevTools Profiler

**æŸ¥çœ‹é‡ç‚¹**:
- æ¸²æŸ“æ¬¡æ•°æ˜¯å¦åˆç†
- å¹³å‡æ¸²æŸ“æ—¶é—´
- æ˜¯å¦æœ‰ä¸å¿…è¦çš„ props å˜åŒ–

## ğŸ› ï¸ è¿›é˜¶è°ƒè¯•æŠ€å·§

### 1. ä½¿ç”¨ Chrome Performance Profiler

```javascript
// åœ¨æ§åˆ¶å°è¿è¡Œ
performance.mark('start');
// æ‰§è¡Œæ“ä½œ...
performance.mark('end');
performance.measure('operation', 'start', 'end');
console.log(performance.getEntriesByType('measure'));
```

### 2. ç›‘æ§ç‰¹å®šæ“ä½œ

```javascript
// ç›‘æ§æ»šåŠ¨æ€§èƒ½
let scrollCount = 0;
const scrollObserver = new PerformanceObserver((list) => {
  scrollCount++;
  console.log(`Scroll event ${scrollCount}`, list.getEntries());
});
scrollObserver.observe({ entryTypes: ['measure'] });
```

### 3. æ£€æµ‹å†…å­˜æ³„æ¼

```javascript
// å®šæœŸæ£€æŸ¥å†…å­˜ä½¿ç”¨
setInterval(() => {
  if (performance.memory) {
    console.log({
      usedJSHeapSize: (performance.memory.usedJSHeapSize / 1048576).toFixed(2) + ' MB',
      totalJSHeapSize: (performance.memory.totalJSHeapSize / 1048576).toFixed(2) + ' MB',
      jsHeapSizeLimit: (performance.memory.jsHeapSizeLimit / 1048576).toFixed(2) + ' MB',
    });
  }
}, 5000);
```

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

ä»¥ä¸‹æ˜¯ä¿®å¤åçš„æ€§èƒ½åŸºå‡†ï¼Œä¾›å‚è€ƒï¼š

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æ”¹å–„ |
|------|--------|--------|------|
| Messages ç»„ä»¶æ¸²æŸ“æ¬¡æ•°ï¼ˆ1åˆ†é’Ÿï¼‰ | 200+ | < 50 | â†“ 75% |
| å¹³å‡æ¸²æŸ“æ—¶é—´ | 25ms | < 10ms | â†“ 60% |
| æ»šåŠ¨ FPS | 30-40 | 55-60 | â†‘ 50% |
| å†…å­˜ä½¿ç”¨ï¼ˆ1å°æ—¶ï¼‰ | æŒç»­å¢é•¿ | ç¨³å®š | âœ… |
| CPU ä½¿ç”¨ï¼ˆæµå¼è¾“å‡ºï¼‰ | 80%+ | < 40% | â†“ 50% |

## ğŸš¨ å·²çŸ¥é—®é¢˜ä¸é™åˆ¶

1. **å¤§é‡å†å²æ¶ˆæ¯**
   - è¶…è¿‡ 500 æ¡æ¶ˆæ¯æ—¶å¯èƒ½å½±å“æ€§èƒ½
   - å»ºè®®å®ç°è™šæ‹Ÿæ»šåŠ¨æˆ–åˆ†é¡µåŠ è½½

2. **å¤æ‚ Markdown æ¸²æŸ“**
   - åŒ…å«å¤§é‡ä»£ç å—çš„æ¶ˆæ¯æ¸²æŸ“è¾ƒæ…¢
   - è€ƒè™‘å»¶è¿Ÿæ¸²æŸ“æˆ–æ‡’åŠ è½½

3. **å›¾ç‰‡/åª’ä½“é™„ä»¶**
   - å¤§é‡å›¾ç‰‡å¯èƒ½å ç”¨å†…å­˜
   - å»ºè®®å®ç°å›¾ç‰‡æ‡’åŠ è½½å’Œå¸è½½æœºåˆ¶

## ğŸ“ æŠ¥å‘Šé—®é¢˜

å¦‚æœåœ¨æµ‹è¯•ä¸­å‘ç°æ–°çš„æ€§èƒ½é—®é¢˜ï¼š

1. è®°å½•è¯¦ç»†çš„å¤ç°æ­¥éª¤
2. æˆªå–æ€§èƒ½åˆ†ææˆªå›¾
3. è®°å½• `__printPerformanceReport()` è¾“å‡º
4. æä¾›æµè§ˆå™¨å’Œç³»ç»Ÿä¿¡æ¯
5. åœ¨ GitHub Issues ä¸­æäº¤æŠ¥å‘Š

---

**æœ€åæ›´æ–°**: 2026-01-22
**ç‰ˆæœ¬**: 1.0
