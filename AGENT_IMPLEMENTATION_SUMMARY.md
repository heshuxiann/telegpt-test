# Agent Chat ç³»ç»Ÿå®ç°æ€»ç»“

## å®ç°æ¦‚è§ˆ

æœ¬æ¬¡å®ç°å®Œæˆäº†ä» `@ai-sdk/react` çš„ `useChat` hook åˆ°è‡ªå®šä¹‰ Agent Chat ç³»ç»Ÿçš„å®Œæ•´è¿ç§»ï¼Œæ”¯æŒæµå¼å¯¹è¯ã€å·¥å…·è°ƒç”¨ã€å¼•ç”¨ç³»ç»Ÿå’Œ MCP é›†æˆã€‚

## å·²åˆ›å»ºçš„æ–‡ä»¶

### æ ¸å¿ƒæ¨¡å—

1. **agent/types.ts** (å·²å­˜åœ¨)
   - Agent æ‰§è¡Œå‚æ•°å’Œç»“æœç±»å‹å®šä¹‰

2. **agent/stream-events.ts** (å·²å­˜åœ¨)
   - äº‹ä»¶ç±»å‹å®šä¹‰å’Œè¾…åŠ©å‡½æ•°
   - é˜¶æ®µæšä¸¾å’Œäº‹ä»¶æšä¸¾

3. **agent/mcp-tools.ts** (å·²å­˜åœ¨)
   - MCP å·¥å…·æ¥å£å®šä¹‰

4. **agent/mcp-websocket.ts** âœ¨ æ–°å»º
   - WebSocket ç®¡ç†å™¨ï¼Œå¤„ç† MCP å·¥å…·è°ƒç”¨
   - è‡ªåŠ¨é‡è¿ã€è¶…æ—¶ç®¡ç†
   - Promise é£æ ¼ API

5. **agent/stream-parser.ts** âœ¨ æ–°å»º
   - æµå¼äº‹ä»¶è§£æå™¨
   - å¤„ç†æ‰€æœ‰äº‹ä»¶ç±»å‹
   - ç¼“å†²åŒºç®¡ç†

6. **agent/useAgentChat.ts** âœ¨ æ–°å»º
   - è‡ªå®šä¹‰ React Hook
   - æ›¿ä»£ `useChat`
   - å®Œæ•´çš„çŠ¶æ€ç®¡ç†

7. **agent/index.ts** âœ¨ æ–°å»º
   - ç»Ÿä¸€å¯¼å‡ºæ‰€æœ‰ Agent æ¨¡å—

8. **agent/README.md** âœ¨ æ–°å»º
   - å®Œæ•´çš„ä½¿ç”¨æ–‡æ¡£å’Œé›†æˆæŒ‡å—

### UI ç»„ä»¶

9. **room-ai/PhaseIndicator.tsx** âœ¨ æ–°å»º
   - é˜¶æ®µæŒ‡ç¤ºå™¨ç»„ä»¶
   - æ˜¾ç¤ºå½“å‰æ‰§è¡Œé˜¶æ®µ

10. **room-ai/PhaseIndicator.module.scss** âœ¨ æ–°å»º
    - é˜¶æ®µæŒ‡ç¤ºå™¨æ ·å¼

11. **room-ai/ToolCallCard.tsx** âœ¨ æ–°å»º
    - å·¥å…·è°ƒç”¨å¡ç‰‡ç»„ä»¶
    - æ˜¾ç¤ºå·¥å…·åç§°ã€å‚æ•°ã€çŠ¶æ€ã€ç»“æœ

12. **room-ai/ToolCallCard.module.scss** âœ¨ æ–°å»º
    - å·¥å…·è°ƒç”¨å¡ç‰‡æ ·å¼

### å·¥å…·å¤„ç†

13. **util/mcpToolHandler.ts** âœ¨ æ–°å»º
    - MCP å·¥å…·è°ƒç”¨æ¶ˆæ¯å¤„ç†å™¨
    - é›†æˆåˆ°å…¨å±€ WebSocket æµç¨‹

## å·²ä¿®æ”¹çš„æ–‡ä»¶

1. **room-ai/room-ai.tsx** ğŸ”§ å·²æ›´æ–°
   - ç§»é™¤ `useChat` å¯¼å…¥
   - ä½¿ç”¨ `useAgentChat` hook
   - æ·»åŠ é˜¶æ®µæŒ‡ç¤ºå™¨å’Œå·¥å…·è°ƒç”¨å¡ç‰‡å±•ç¤º
   - ç®€åŒ– `handleInputSubmit` é€»è¾‘

2. **room-ai/room-ai.module.scss** ğŸ”§ å·²æ›´æ–°
   - æ·»åŠ  `.phaseIndicatorContainer` æ ·å¼
   - æ·»åŠ  `.toolCallsContainer` æ ·å¼

3. **room-ai/room-ai-input.tsx** ğŸ”§ å·²æ›´æ–°
   - ç§»é™¤ `UseChatHelpers` ç±»å‹ä¾èµ–
   - ä½¿ç”¨è‡ªå®šä¹‰ `ChatStatus` ç±»å‹
   - æ›´æ–°çŠ¶æ€åˆ¤æ–­ï¼ˆ`submitted` â†’ `streaming`ï¼‰

4. **global/actions/apiUpdaters/initial.ts** ğŸ”§ å·²æ›´æ–°
   - å¯¼å…¥ MCP å·¥å…·å¤„ç†å‡½æ•°
   - æ‰©å±• `onMessage` å¤„ç†å™¨
   - æ·»åŠ  MCP å·¥å…·è°ƒç”¨å’Œå“åº”å¤„ç†

## æ ¸å¿ƒåŠŸèƒ½

### 1. æµå¼å¯¹è¯
- âœ… å®æ—¶æ¥æ”¶å’Œæ˜¾ç¤ºæµå¼æ–‡æœ¬
- âœ… æ”¯æŒåœæ­¢å’Œé‡è¯•
- âœ… é”™è¯¯å¤„ç†å’Œæ¢å¤

### 2. é˜¶æ®µç®¡ç†
- âœ… æ€è€ƒé˜¶æ®µ (thinking)
- âœ… å·¥å…·è°ƒç”¨é˜¶æ®µ (tool_calling)
- âœ… ç”Ÿæˆé˜¶æ®µ (generating)
- âœ… å®Œæˆé˜¶æ®µ (completed)
- âœ… é”™è¯¯é˜¶æ®µ (error)

### 3. å·¥å…·è°ƒç”¨
- âœ… å·¥å…·è°ƒç”¨å¼€å§‹æç¤º
- âœ… æ˜¾ç¤ºå·¥å…·å‚æ•°
- âœ… å·¥å…·æ‰§è¡ŒçŠ¶æ€åé¦ˆ
- âœ… æˆåŠŸ/å¤±è´¥çŠ¶æ€æ˜¾ç¤º

### 4. å¼•ç”¨ç³»ç»Ÿ
- âœ… è§£æ citation äº‹ä»¶
- âœ… å­˜å‚¨å¼•ç”¨ä¿¡æ¯
- âœ… æ”¯æŒç‚¹å‡»è·³è½¬ï¼ˆå¾… UI å®ç°ï¼‰

### 5. MCP é›†æˆ
- âœ… WebSocket è¿æ¥ç®¡ç†
- âœ… å·¥å…·è°ƒç”¨è¯·æ±‚/å“åº”
- âœ… è‡ªåŠ¨é‡è¿æœºåˆ¶

### 6. æ¶ˆæ¯æŒä¹…åŒ–
- âœ… IndexedDB å­˜å‚¨ï¼ˆç»§æ‰¿åŸæœ‰é€»è¾‘ï¼‰
- âœ… æ¶ˆæ¯åˆ—è¡¨åˆ†é¡µåŠ è½½
- âœ… å†å²è®°å½•æ¢å¤

## æŠ€æœ¯äº®ç‚¹

### 1. ç±»å‹å®‰å…¨
- å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- ä¸¥æ ¼çš„äº‹ä»¶ç±»å‹æ£€æŸ¥
- æ³›å‹æ”¯æŒ

### 2. æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨ `memo` ä¼˜åŒ–ç»„ä»¶æ¸²æŸ“
- æµå¼æ•°æ®ç¼“å†²å¤„ç†
- äº‹ä»¶è§£ææ€§èƒ½ä¼˜åŒ–

### 3. é”™è¯¯å¤„ç†
- HTTP è¯·æ±‚é”™è¯¯
- WebSocket è¿æ¥é”™è¯¯
- å·¥å…·è°ƒç”¨é”™è¯¯
- æµå¼å“åº”ä¸­æ–­

### 4. ç”¨æˆ·ä½“éªŒ
- å®æ—¶é˜¶æ®µåé¦ˆ
- å·¥å…·è°ƒç”¨å¯è§†åŒ–
- æ¸…æ™°çš„çŠ¶æ€æŒ‡ç¤º
- å¹³æ»‘çš„åŠ è½½åŠ¨ç”»

## ä½¿ç”¨æµç¨‹

```typescript
// 1. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ hook
const {
  messages,
  status,
  currentPhase,
  toolCalls,
  append,
  stop,
} = useAgentChat({
  chatId: '123',
  showToolCalls: true,
  detailedCitations: true,
});

// 2. å‘é€æ¶ˆæ¯
await append({
  role: 'user',
  content: 'æœ€è¿‘ä¸€å‘¨æåˆ°çš„é—®é¢˜æœ‰å“ªäº›',
  id: uuidv4(),
  createdAt: new Date(),
});

// 3. æœåŠ¡ç«¯è¿”å›äº‹ä»¶æµ
// phase_change â†’ tool_start â†’ tool_end â†’ text â†’ citation â†’ done

// 4. UI è‡ªåŠ¨æ›´æ–°
// - é˜¶æ®µæŒ‡ç¤ºå™¨æ˜¾ç¤ºå½“å‰é˜¶æ®µ
// - å·¥å…·è°ƒç”¨å¡ç‰‡æ˜¾ç¤ºæ‰§è¡ŒçŠ¶æ€
// - æ–‡æœ¬å†…å®¹å®æ—¶è¿½åŠ 
// - å¼•ç”¨ä¿¡æ¯æ ‡è®°åœ¨æ–‡æœ¬ä¸­
```

## é…ç½®è¦æ±‚

### å‰ç«¯
- Node 22.6+/24+
- React (Teact)
- TypeScript 5+

### åç«¯
- éœ€è¦å®ç° `/chat` ç«¯ç‚¹
- æ”¯æŒ `text/event-stream`
- è¿”å›ç¬¦åˆ `AGENT_STREAM_FORMAT.md` çš„äº‹ä»¶æµ

### Headers
```
user-id: <userId>
device-id: <deviceId>
Content-Type: application/json
```

### WebSocket
- å¯é€‰çš„ MCP WebSocket æœåŠ¡
- ç”¨äºå®æ—¶å·¥å…·è°ƒç”¨
- è‡ªåŠ¨é‡è¿æœºåˆ¶

## å¾…å®Œå–„åŠŸèƒ½

1. **å¼•ç”¨ç‚¹å‡»è·³è½¬**
   - éœ€è¦åœ¨ Messages ç»„ä»¶ä¸­å®ç°ç‚¹å‡»è·³è½¬é€»è¾‘
   - æ ¹æ® chatId å’Œ messageId å®šä½åˆ°å…·ä½“æ¶ˆæ¯

2. **æ€è€ƒè¿‡ç¨‹å±•ç¤º**
   - å½“ `showThinking: true` æ—¶æ˜¾ç¤º AI æ€è€ƒè¿‡ç¨‹
   - å¯æŠ˜å çš„æ€è€ƒé¢æ¿

3. **ç»“æ„åŒ–æ•°æ®å±•ç¤º**
   - å¤„ç† `structured` äº‹ä»¶
   - ä»¥è¡¨æ ¼æˆ–å›¾è¡¨å½¢å¼å±•ç¤ºæ•°æ®

4. **å¤šæ¨¡æ€æ”¯æŒ**
   - å›¾ç‰‡ä¸Šä¼ å’Œè¯†åˆ«
   - éŸ³é¢‘è¾“å…¥
   - æ–‡ä»¶é™„ä»¶

5. **æ›´å¤šå·¥å…·**
   - æœç´¢å·¥å…·
   - æ—¥å†å·¥å…·
   - è®¡ç®—å·¥å…·

## æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•
- [ ] AgentStreamParser è§£æé€»è¾‘
- [ ] McpWebSocketManager è¿æ¥ç®¡ç†
- [ ] useAgentChat hook çŠ¶æ€ç®¡ç†

### é›†æˆæµ‹è¯•
- [ ] å®Œæ•´çš„å¯¹è¯æµç¨‹
- [ ] å·¥å…·è°ƒç”¨æµç¨‹
- [ ] é”™è¯¯æ¢å¤æµç¨‹

### E2E æµ‹è¯•
- [ ] ç”¨æˆ·å‘é€æ¶ˆæ¯
- [ ] æŸ¥çœ‹å·¥å…·è°ƒç”¨
- [ ] ç‚¹å‡»å¼•ç”¨è·³è½¬

## ç›‘æ§å’Œæ—¥å¿—

ç³»ç»Ÿå·²é›†æˆæ—¥å¿—è¾“å‡ºï¼š
```typescript
// æµè§ˆå™¨æ§åˆ¶å°
[Agent] Processing request for user: 7309054898
[Agent] Phase: æ­£åœ¨åˆ†ææ‚¨çš„é—®é¢˜...
[Agent] Tool call request: get_messages
[Agent] Citation: {...}
[MCP WebSocket] Connected
[MCP] Tool call request: get_messages
```

## éƒ¨ç½²æ³¨æ„äº‹é¡¹

1. ç¡®ä¿æœåŠ¡ç«¯ `/chat` ç«¯ç‚¹å·²å®ç°
2. é…ç½®æ­£ç¡®çš„ `SERVER_API_URL`
3. å¦‚æœä½¿ç”¨ MCPï¼Œé…ç½® WebSocket URL
4. æ£€æŸ¥ CORS è®¾ç½®
5. ç¡®ä¿ Headers æ­£ç¡®ä¼ é€’

## è¿ç§»æŒ‡å—

ä»æ—§çš„ `useChat` è¿ç§»åˆ° `useAgentChat`ï¼š

```typescript
// æ—§ä»£ç 
import { useChat } from '@ai-sdk/react';

const { messages, append, status } = useChat({
  api: `${SERVER_API_URL}/chat`,
  id: chatId,
});

// æ–°ä»£ç 
import { useAgentChat } from '../agent/useAgentChat';

const { messages, append, status, currentPhase, toolCalls } = useAgentChat({
  chatId,
  showToolCalls: true,
});
```

ä¸»è¦åŒºåˆ«ï¼š
1. çŠ¶æ€ç±»å‹å˜åŒ–ï¼š`'submitted'` â†’ `'streaming'`
2. æ–°å¢ `currentPhase` å’Œ `toolCalls`
3. Headers è‡ªåŠ¨ç®¡ç†
4. æ”¯æŒé…ç½®é€‰é¡¹

## æ€»ç»“

æœ¬æ¬¡å®ç°å®Œæˆäº†ï¼š
- âœ… 13 ä¸ªæ–°æ–‡ä»¶åˆ›å»º
- âœ… 4 ä¸ªæ–‡ä»¶ä¿®æ”¹
- âœ… å®Œæ•´çš„ç±»å‹å®šä¹‰
- âœ… æµå¼äº‹ä»¶è§£æ
- âœ… WebSocket é›†æˆ
- âœ… UI ç»„ä»¶å®ç°
- âœ… æ–‡æ¡£å’Œç¤ºä¾‹

ç³»ç»Ÿç°åœ¨å…·å¤‡ï¼š
- ğŸ¯ å®Œæ•´çš„ Agent å¯¹è¯èƒ½åŠ›
- ğŸ› ï¸ å·¥å…·è°ƒç”¨å¯è§†åŒ–
- ğŸ“ å¼•ç”¨ç³»ç»Ÿ
- ğŸ”„ å®æ—¶çŠ¶æ€åé¦ˆ
- ğŸ”Œ MCP å·¥å…·é›†æˆ
- ğŸ“± å“åº”å¼ UI

ä¸‹ä¸€æ­¥å¯ä»¥æ ¹æ®éœ€æ±‚æ·»åŠ æ›´å¤šå·¥å…·å’Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒã€‚
